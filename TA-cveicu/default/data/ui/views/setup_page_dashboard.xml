<dashboard version="1.1" hideEdit="true" hideFilters="true" script="setup_complete.js">
    <label>CVE.ICU Setup</label>
    <description>Configure CVE.ICU</description>
    
    <row>
        <panel>
            <html>
                <style>
                    .setup-container {
                        max-width: 700px;
                        margin: 40px auto;
                        padding: 40px;
                        background: #fff;
                        border-radius: 12px;
                        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
                        text-align: center;
                    }
                    .setup-header h1 {
                        color: #d32f2f;
                        font-size: 32px;
                        margin-bottom: 10px;
                    }
                    .setup-header p {
                        color: #666;
                        font-size: 16px;
                        margin-bottom: 30px;
                    }
                    .info-section {
                        background: #f5f5f5;
                        padding: 20px;
                        border-radius: 8px;
                        margin: 20px 0;
                        text-align: left;
                    }
                    .info-section h3 {
                        margin: 0 0 10px 0;
                        color: #333;
                    }
                    .info-section p {
                        margin: 0;
                        color: #666;
                        font-size: 14px;
                    }
                    .info-section ul {
                        margin: 10px 0 0 0;
                        padding-left: 20px;
                        color: #666;
                    }
                    .btn-complete {
                        display: inline-block;
                        padding: 15px 50px;
                        font-size: 18px;
                        font-weight: 600;
                        color: #fff;
                        background: #d32f2f;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        text-decoration: none;
                        margin-top: 20px;
                    }
                    .btn-complete:hover {
                        background: #b71c1c;
                        color: #fff;
                        text-decoration: none;
                    }
                    .setup-status {
                        margin-top: 15px;
                        padding: 10px;
                        border-radius: 4px;
                        display: none;
                    }
                    .setup-status.loading {
                        display: block;
                        background: #e3f2fd;
                        color: #1565c0;
                    }
                    .setup-status.success {
                        display: block;
                        background: #e8f5e9;
                        color: #2e7d32;
                    }
                    .setup-status.error {
                        display: block;
                        background: #ffebee;
                        color: #c62828;
                    }
                </style>
                
                <div class="setup-container">
                    <div class="setup-header">
                        <h1>&#x1F691; CVE.ICU Setup</h1>
                        <p>Your CVE vulnerability intelligence platform is ready!</p>
                    </div>
                    
                    <div class="info-section">
                        <h3>What's Included</h3>
                        <ul>
                            <li>311,000+ CVE records from the official CVE Program</li>
                            <li>Instant-loading dashboard with pre-calculated statistics</li>
                            <li>CVSS scoring and severity analysis</li>
                            <li>Vendor and product vulnerability tracking</li>
                            <li>Hourly delta updates for new CVEs</li>
                        </ul>
                    </div>
                    
                    <div class="info-section">
                        <h3>No Configuration Required</h3>
                        <p>CVE.ICU works out of the box with no API keys or tokens needed. The hourly update process uses anonymous GitHub API access which is sufficient for delta updates.</p>
                    </div>
                    
                    <div class="info-section">
                        <h3>Dashboard Theme</h3>
                        <p>Select your preferred dashboard appearance:</p>
                        <div style="margin-top: 15px;">
                            <label style="display: inline-flex; align-items: center; margin-right: 30px; cursor: pointer;">
                                <input type="radio" name="theme" value="light" checked="checked" style="margin-right: 8px;"/>
                                <span>‚òÄÔ∏è Light Mode</span>
                            </label>
                            <label style="display: inline-flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="theme" value="dark" style="margin-right: 8px;"/>
                                <span>üåô Dark Mode</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="setup-status" class="setup-status"></div>
                    
                    <button id="launch-btn" class="btn-complete" onclick="completeSetup()">
                        Launch Dashboard
                    </button>
                </div>
                
                <script>
                    function completeSetup() {
                        var statusDiv = document.getElementById('setup-status');
                        var btn = document.getElementById('launch-btn');
                        
                        // Show loading state
                        statusDiv.className = 'setup-status loading';
                        statusDiv.textContent = 'Completing setup...';
                        btn.disabled = true;
                        btn.style.opacity = '0.6';
                        
                        // Call the setup REST handler to mark as configured
                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', '/en-US/splunkd/__raw/servicesNS/nobody/TA-cveicu/TA_cveicu_setup/github_settings', true);
                        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                        xhr.setRequestHeader('X-Splunk-Form-Key', window.$C ? window.$C.FORM_KEY : '');
                        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                        
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200 || xhr.status === 201) {
                                    statusDiv.className = 'setup-status success';
                                    statusDiv.textContent = 'Setup complete! Redirecting...';
                                    
                                    // Small delay to allow Splunk to refresh, then redirect
                                    setTimeout(function() {
                                        window.location.href = '/en-US/app/TA-cveicu/cve_dashboard_instant';
                                    }, 500);
                                } else {
                                    // Even if the REST call fails, try to redirect anyway
                                    // The default/app.conf already has is_configured=true
                                    statusDiv.className = 'setup-status success';
                                    statusDiv.textContent = 'Redirecting to dashboard...';
                                    setTimeout(function() {
                                        window.location.href = '/en-US/app/TA-cveicu/cve_dashboard_instant';
                                    }, 300);
                                }
                            }
                        };
                        
                        xhr.onerror = function() {
                            // On error, still redirect - default config should work
                            window.location.href = '/en-US/app/TA-cveicu/cve_dashboard_instant';
                        };
                        
                        // Send theme preference along with empty token
                        var theme = document.querySelector('input[name="theme"]:checked').value;
                        xhr.send('github_token=&amp;theme=' + theme);
                    }
                </script>
            </html>
        </panel>
    </row>
</dashboard>
