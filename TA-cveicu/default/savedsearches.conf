# Pre-computed lookup refresh searches for instant dashboard loading
# These scheduled searches update CSV lookups used by the dashboard

[CVE Total Lookup Refresh]
enableSched = 1
cron_schedule = */15 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
search = index=main sourcetype="cveicu:record" \
| rex field=_raw "\"cveId\"\s*:\s*\"(?<cve_id>CVE-\d{4}-\d+)\"" \
| rex field=_raw "\"state\"\s*:\s*\"(?<cve_state>PUBLISHED)\"" \
| where cve_state="PUBLISHED" \
| stats dc(cve_id) as total_cves \
| eval last_updated=now() \
| outputlookup cve_total.csv

[CVE Daily Summary Lookup Refresh]
enableSched = 1
cron_schedule = 5 * * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
search = index=main sourcetype="cveicu:record" \
| rex field=_raw "\"cveId\"\s*:\s*\"(?<cve_id>CVE-\d{4}-\d+)\"" \
| rex field=_raw "\"state\"\s*:\s*\"(?<cve_state>PUBLISHED)\"" \
| rex field=_raw "\"datePublished\"\s*:\s*\"(?<date_published>\d{4}-\d{2}-\d{2})" \
| rex field=_raw "\"baseSeverity\"\s*:\s*\"(?<severity>CRITICAL|HIGH|MEDIUM|LOW)\"" \
| where cve_state="PUBLISHED" AND isnotnull(date_published) \
| eval severity=if(isnull(severity), "NONE", severity) \
| stats dc(cve_id) as cve_count by date_published severity \
| outputlookup cve_daily_summary.csv

[CVE Vendors Lookup Refresh]
enableSched = 1
cron_schedule = 10 * * * *
dispatch.earliest_time = -30d@d
dispatch.latest_time = now
search = index=main sourcetype="cveicu:record" \
| rex field=_raw "\"cveId\"\s*:\s*\"(?<cve_id>CVE-\d{4}-\d+)\"" \
| rex field=_raw "\"state\"\s*:\s*\"(?<cve_state>PUBLISHED)\"" \
| rex field=_raw "\"vendor\"\s*:\s*\"(?<vendor>[^\"]+)\"" \
| where cve_state="PUBLISHED" AND isnotnull(vendor) AND vendor!="n/a" \
| stats dc(cve_id) as cve_count by vendor \
| sort - cve_count \
| head 50 \
| outputlookup cve_vendors.csv

#
# EPSS and KEV Enrichment Lookups
# Run the Python script to fetch fresh data from FIRST and CISA
#

[EPSS Lookup Refresh]
enableSched = 1
cron_schedule = 0 6 * * *
dispatch.earliest_time = -1h
dispatch.latest_time = now
description = Fetches FIRST EPSS scores daily at 6 AM
search = | script cveicu_epss_kev epss \
| stats count \
| eval status="EPSS lookup refreshed"

[KEV Lookup Refresh]
enableSched = 1
cron_schedule = 0 */6 * * *
dispatch.earliest_time = -1h
dispatch.latest_time = now
description = Fetches CISA KEV catalog every 6 hours
search = | script cveicu_epss_kev kev \
| stats count \
| eval status="KEV lookup refreshed"

#
# Risk Priority Lookup - Pre-compute risk scores
#

[Risk Priority Lookup Refresh]
enableSched = 1
cron_schedule = 30 * * * *
dispatch.earliest_time = -1y
dispatch.latest_time = now
description = Pre-computes risk priority scores for all CVEs
search = index=main sourcetype="cveicu:record" \
| rex field=_raw "\"cveId\"\s*:\s*\"(?<cve_id>CVE-\d{4}-\d+)\"" \
| rex field=_raw "\"state\"\s*:\s*\"(?<cve_state>PUBLISHED)\"" \
| rex field=_raw "\"baseScore\"\s*:\s*(?<cvss_score>[\d.]+)" \
| rex field=_raw "\"Exploitation\"\s*:\s*\"(?<ssvc_exploitation>[^\"]+)\"" \
| where cve_state="PUBLISHED" \
| lookup epss_lookup.csv cve_id OUTPUT epss_score \
| lookup kev_lookup.csv cve_id OUTPUT in_kev \
| eval cvss_score=coalesce(tonumber(cvss_score), 0) \
| eval epss_score=coalesce(tonumber(epss_score), 0.001) \
| eval kev_mult=if(in_kev="true", 2, 1) \
| eval ssvc_mult=case(ssvc_exploitation="active", 2, ssvc_exploitation="poc", 1.5, 1=1, 1) \
| eval risk_priority=round(cvss_score * (1 + epss_score * 10) * kev_mult * ssvc_mult, 2) \
| dedup cve_id \
| table cve_id cvss_score epss_score in_kev ssvc_exploitation risk_priority \
| outputlookup risk_priority_lookup.csv

